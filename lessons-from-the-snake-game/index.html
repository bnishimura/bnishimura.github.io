<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" charSet="utf-8"/><meta name="generator" content="Gatsby 4.14.1"/><style data-href="/styles.927c5c6a8cd7a67e6a79.css" data-identity="gatsby-global-css">.page-content{max-width:var(--size-content);padding:0 var(--size-gutter);width:100%}.post-preview p{margin:var(--space-1) 0;width:100%}.post-sub-header{display:flex;flex-direction:row;justify-content:flex-start;margin-top:2px}.post-date{font-size:var(--font-sx);font-weight:400;margin-right:.3rem}.post-preview-title{color:var(--color-special-text);display:block;font-size:22pt;padding:0;text-decoration:none}.post-excerpt{width:auto}.nav-header{align-items:center;display:flex;font-family:var(--font-family-nav);justify-content:space-between;padding:.75rem var(--size-gutter)}.nav-brand{font-size:var(--font-nav-big);text-decoration:none}.nav-link{float:right;font-size:var(--font-nav-sm);text-decoration:none}:root{--color-text:#fff;--color-special-text:gold;--color-bg:#292929;--color-brand:#000;--tag-bg:#141414;--color-code-bg:#fff4db;--color-code:#8a6534;--border-radius:3px;--font-family-blog:"Roboto",sans-serif;--font-family-nav:"Anton",sans-serif;--font-mono:"Consolas",sans-serif,monospace;--font-nav-big:30px;--font-nav-sm:16px;--font-lg:18px;--font-md:16px;--font-sm:14px;--font-sx:12px;--line-height-loose:1.75;--line-height-normal:1.5;--line-height-dense:1.1;--space-1:4px;--space-2:8px;--space-3:16px;--space-4:24px;--space-5:32px;--space-6:64px;--size-content:52rem;--size-gutter:var(--space-5);--size-gap:var(--space-6)}html{-webkit-text-size-adjust:100%;box-sizing:border-box;font:sans-serif;font-size:var(--font-md);line-height:var(--line-height-normal);overflow-y:scroll}body{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;word-wrap:break-word;background:var(--color-bg);color:var(--color-text);display:flex;font-family:var(--font-family-blog);font-weight:400;justify-content:center;margin:0}a{background-color:transparent;color:var(--color-special-text);font-weight:500;text-decoration:none;text-decoration:underline;text-decoration-thickness:1.5px;text-underline-offset:2px}a:active,a:hover{outline-width:0;text-decoration:none}abbr[title]{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help;text-decoration:none}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:26pt;letter-spacing:-.01em;line-height:var(--line-height-dense);margin:var(--space-2) 0 0 0;padding:0;text-decoration:none}h1>b{color:var(--color-special-text)}img{border-style:none;max-width:100%}code,kbd,pre,samp{font-family:var(--font-mono);font-size:1em;line-height:inherit}hr{background:rgba(0,0,0,.4);border:none;box-sizing:content-box;height:1px;margin-bottom:var(--space-3);margin-left:0;margin-right:0;margin-top:var(--space-3);overflow:visible}*,:after,:before{box-sizing:inherit}dd,dl,fieldset,figure,hgroup,img,ol,ul{list-style-image:none;list-style-position:outside;margin-left:var(--space-4)}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:var(--border-radius);font-size:.875rem;line-height:var(--line-height-normal);margin-bottom:var(--space-4);margin-left:0;margin-right:0;margin-top:0;overflow:auto;padding:var(--space-4)}b,dt,strong,th{font-weight:700}li{margin-bottom:calc(var(--space-4)/2)}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:calc(var(--space-4)/2);margin-left:var(--space-4);margin-top:calc(var(--space-4)/2)}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}p{font-size:var(--font-lg)}li>p{margin-bottom:calc(var(--space-4)/2)}code,kbd,samp{font-size:.875rem}abbr,acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}code,tt{background-color:var(--color-code-bg);border-radius:var(--border-radius);color:var(--color-code);font-family:var(--font-mono);padding-bottom:.25em;padding-top:.25em;word-break:normal}pre code{background:none}code:after,code:before,tt:after,tt:before{content:"\00a0";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:none}footer{font-size:var(--font-sx);padding:0 var(--size-gutter)}footer p:first-child{margin-top:var(--space-4);text-align:center}footer p:last-child{align-self:flex-end;text-align:left}#___gatsby,#gatsby-focus-wrapper,.main-container{max-width:var(--size-content);width:100%}.content-hr,.tag-filter{margin:0 var(--size-gutter)}.tag-filter{max-width:var(--size-content)}.expandable-bar{background:#000;flex-wrap:wrap;height:auto;max-width:var(--size-content);position:relative}.expandable-bar,.toggle-bar{display:flex;justify-content:center}.toggle-bar{align-self:flex-start;background:#1e1e1e;height:.8rem;width:100%}.expand-icon,.tags{align-self:center}.tags{border:1px solid;border-color:var(--tag-bg);border-radius:var(--border-radius);color:var(--color-special-text);display:inline-block;font-size:var(--font-sx);height:-webkit-max-content;height:max-content;margin:0 3px 3px 0;padding:1px 5px;text-align:center;width:-webkit-max-content;width:max-content}.post-header{font-family:var(--font-family-blog);margin-bottom:var(--space-3)}.post-title{color:var(--color-special-text);margin-bottom:0;text-decoration:none}.post-date{font-size:var(--font-sm)}.blog-post-container{font-family:var(--font-family-blog);margin-top:var(--space-3);max-width:var(--size-content);padding:0 var(--size-gutter);width:100%}.blog-post-container h1,h2,h3,h4,h5,h6{font-weight:400;letter-spacing:-.01em;line-height:var(--line-height-dense);padding:0;text-decoration:none}</style><title data-react-helmet="true">NishiWare - Lessons from the snake game</title><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&amp;display=swap" rel="stylesheet"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css2?family=Anton&amp;family=Roboto:wght@100&amp;display=swap" rel="stylesheet"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=2288a15247b5ae063d507d8270d23cc2" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=2288a15247b5ae063d507d8270d23cc2"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=2288a15247b5ae063d507d8270d23cc2"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="main-container"><div class="nav-header"><a class="nav-brand" href="/">NishiWare</a><a href="https://github.com/bnishimura/" class="nav-link"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:32px;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;32&#x27; width=&#x27;32&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#080808;position:absolute;top:0;left:0;bottom:0;right:0"></div><picture><source type="image/webp" data-srcset="/static/8d0dbcd578da93ae64927691aeb01990/5d252/github-logo.webp 8w,/static/8d0dbcd578da93ae64927691aeb01990/e789a/github-logo.webp 16w,/static/8d0dbcd578da93ae64927691aeb01990/ef6ff/github-logo.webp 32w,/static/8d0dbcd578da93ae64927691aeb01990/8257c/github-logo.webp 64w" sizes="(min-width: 32px) 32px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 32px) 32px, 100vw" decoding="async" loading="lazy" data-src="/static/8d0dbcd578da93ae64927691aeb01990/914ee/github-logo.png" data-srcset="/static/8d0dbcd578da93ae64927691aeb01990/22867/github-logo.png 8w,/static/8d0dbcd578da93ae64927691aeb01990/fbc98/github-logo.png 16w,/static/8d0dbcd578da93ae64927691aeb01990/914ee/github-logo.png 32w,/static/8d0dbcd578da93ae64927691aeb01990/1c9ce/github-logo.png 64w" alt="github logo"/></picture><noscript><picture><source type="image/webp" srcSet="/static/8d0dbcd578da93ae64927691aeb01990/5d252/github-logo.webp 8w,/static/8d0dbcd578da93ae64927691aeb01990/e789a/github-logo.webp 16w,/static/8d0dbcd578da93ae64927691aeb01990/ef6ff/github-logo.webp 32w,/static/8d0dbcd578da93ae64927691aeb01990/8257c/github-logo.webp 64w" sizes="(min-width: 32px) 32px, 100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="(min-width: 32px) 32px, 100vw" decoding="async" loading="lazy" src="/static/8d0dbcd578da93ae64927691aeb01990/914ee/github-logo.png" srcSet="/static/8d0dbcd578da93ae64927691aeb01990/22867/github-logo.png 8w,/static/8d0dbcd578da93ae64927691aeb01990/fbc98/github-logo.png 16w,/static/8d0dbcd578da93ae64927691aeb01990/914ee/github-logo.png 32w,/static/8d0dbcd578da93ae64927691aeb01990/1c9ce/github-logo.png 64w" alt="github logo"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div></a></div><hr class="content-hr"/><div style="max-width:var(--size-content);margin-bottom:var(--size-gutter)"><main><div class="blog-post-container"><div class="post-header"><h1 class="post-title">Lessons from the snake game</h1><p class="post-date">May 12, 2022</p></div><div class="blog-post-content"><p>I<!-- -->&#x27;<!-- -->ve made onde of those old snake games as a first step to learn React:</p><div class="blog-post-content" style="display:flex;justify-content:center"><div style="max-width:var(--size-content);padding:0 auto"><canvas tabindex="0" style="max-width:var(--size-content)" width="0" height="0" id="canvas"></canvas></div></div><p>The code for the game can be found <a href="https://github.com/bnishimura/NishiWare/blob/main/src/pages/lessons-from-the-snake-game/snake.js">here</a>.</p><p>It turns out React is not really a nice and clean way to make a game and the reason for this is mainly
because of React<!-- -->&#x27;<!-- -->s execution flow. Compared to simply updating a canvas with JavaScript, React seems like a
convoluted solution that brings about a lot of complications. But none of this matters since the goal is to
grok the framework. </p><p>There is not really much to talk about in terms of game logic, after all this part of the code is actually
simple JS. The problem lies in the integration between React and the game logic and that<!-- -->&#x27;<!-- -->s what I will explore
in this article.</p><h1>The main hurdle: constant frame rate</h1><hr/><p>This might seem simple to solve at first: we can use the timer methods (like <code>setInterval()</code> or <code>setTimeout()</code>)
from the web APIs to call a game loop that handles the game state at each frame. But then, when you try to play
the game, the canvas does not change even though your timer is getting called at the specified interval.</p><p>The issue in this case is that React seems to, for each render, create a new object that represents the component,
with each object carrying the state of the render as a static value. In other words, calling
<code>setInterval(gameLoop, 1000/FRAME_RATE)</code> will call the gameLoop of the first render FRAME_RATE times per second.
Since each render is a different object and each object has its own scope, carrying a React state that is not
mutable from within the object, gameLoop does not change. Thats the gist of it, now I shall elaborate each point
and outline a solution for it.</p><h2>React states</h2><p>Consider the hook:</p><pre><code>const [count, setCount] = useState(0);
</code></pre><p>Every time the setter setCount is called, React calls the component. This component call is, at least in effect,
the creation of a new component, but this time with a new, hard coded value you fed to the setter. This means
React states inside each generated component are not supposed to be mutated <!-- -->–<!-- --> in fact, it is impossible
to do so (count in the example is constant, you cannot assign to it directly). Therefore, each render is
represented by a different instance of the component.</p><p>So what causes the setInterval issue? Because each render is related to an instance of the game<!-- -->&#x27;<!-- -->s
react component, and a different gameLoop belongs to each instance, there will always be a static React
state inside any given gameLoop<!-- -->&#x27;<!-- -->s scope. Therefore setInterval is using a gameLoop that can only
see the same <!-- -->–<!-- --> immutable <!-- -->–<!-- --> values (in other words, gameLoop<!-- -->&#x27;<!-- -->s scope does not change).</p><h2>Solution</h2><p>The solution is to use a reference:</p><pre><code>const callback = useRef();
const timer = useRef();
useEffect(() =&gt; {
    callback.current = gameLoop;
    function tick() {
        callback.current();
    }
    timer.current = setInterval(tick, 1000/FRAME_RATE);
});
</code></pre><p>With the extra layer of indirection provided by the ref, we can pass the gameLoop of the current instance of the
component. But doing something like <code>setInterval(callback.current, 1000/FRAME_RATE)</code> gives us the same problem,
most likely because refs behave similarly to states (meaning they probably are instance-wise static).
So we create a tick function to execute the gameLoop inside the ref. This way, setInterval does not get stuck
with a statically<!-- -->–<!-- -->scoped gameLoop!</p><p>The real best solution, though, is to not use any React related functionalities. We can just tie the game state
to the component<!-- -->&#x27;<!-- -->s scope and let setInterval call gameLoop that will be responsible to read the game state and
update the canvas. Admittedly when I started this little project, I couldn<!-- -->&#x27;<!-- -->t see this possibility, but at
least I exercised all of the React muscles there are. Pretty cool if you ask me.</p></div></div></main><hr class="content-hr" style="margin-top:var(--space-4)"/><footer><p> The code for this blog can be found <a href="">here</a>.</p><p> © <!-- -->2022<!-- --> · Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></p></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/lessons-from-the-snake-game";window.___webpackCompilationHash="27875445d4b68bea9229";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-4718f0fec20e0d09d7f5.js"],"app":["/app-3bc1ff5124e2c5460627.js"],"component---src-pages-404-js":["/component---src-pages-404-js-495b83b25ad1ac7245a6.js"],"component---src-pages-index-js":["/component---src-pages-index-js-91008b903e54c00ae85a.js"],"component---src-pages-lessons-from-the-snake-game-lessons-from-the-snake-game-mdx":["/component---src-pages-lessons-from-the-snake-game-lessons-from-the-snake-game-mdx-ed0c7c3a539362434497.js"],"component---src-pages-lessons-from-the-snake-game-snake-js":[],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-351090aa7dba1037dca3.js"]};/*]]>*/</script><script src="/polyfill-4718f0fec20e0d09d7f5.js" nomodule=""></script><script src="/app-3bc1ff5124e2c5460627.js" async=""></script><script src="/framework-0de5eaa9f9b5906e339f.js" async=""></script><script src="/webpack-runtime-7734d2dfeccec282ecc9.js" async=""></script></body></html>